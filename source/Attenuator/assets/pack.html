<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Cache-control" content="public" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Proton Pack Settings</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <h1 id="top">Pack Settings</h1>
    <div class="block left">
      <p>
        Change system configuration options using the available toggles and selectors. Options may only be changed when the pack and wand are not powered and running. Use the
        "Update Settings" button to save values to your equipment.
      </p>
      <br />
    </div>

    <h1>General Options</h1>
    <div class="block left">
      <div class="setting">
        <b>Operation Mode:</b>
        <select id="defaultSystemModePack" name="defaultSystemModePack" style="width: 180px">
          <option value="0">Super Hero</option>
          <option value="1">Mode Original</option>
        </select>
      </div>
      <div class="setting">
        <b>&nbsp;&nbsp;Default Theme:</b>
        <select id="defaultYearThemePack" name="defaultYearThemePack" style="width: 180px">
          <option value="1">System Toggle</option>
          <option value="2">1984</option>
          <option value="3">1989</option>
          <option value="4">Afterlife</option>
          <option value="5">Frozen Empire</option>
        </select>
      </div>
      <div class="setting">
        <b>&nbsp;Current Theme:</b>
        <select id="currentYearThemePack" name="currentYearThemePack" style="width: 180px">
          <option value="2">1984</option>
          <option value="3">1989</option>
          <option value="4">Afterlife</option>
          <option value="5">Frozen Empire</option>
        </select>
      </div>
      <div class="setting">
        <b>&nbsp;&nbsp;&nbsp;&nbsp;Use Vibration:</b>
        <select id="packVibration" name="packVibration">
          <option value="1">Always</option>
          <option value="2">When Firing</option>
          <option value="3">Never</option>
          <option value="4">Via Toggle</option>
          <option value="5">Motorized Cyclotron</option>
        </select>
      </div>
      <div class="setting">
        <label class="toggle-switchy" data-text="yesno" data-label="left">
          <input id="overheatLightsOff" name="overheatLightsOff" type="checkbox" />
          <span class="toggle">
            <span class="switch"></span>
          </span>
          <span class="label">Lights Off During Overheat:</span>
        </label>
      </div>
      <div class="setting">
        <label class="toggle-switchy" data-text="yesno" data-label="left">
          <input id="overheatStrobeNF" name="overheatStrobeNF" type="checkbox" />
          <span class="toggle">
            <span class="switch"></span>
          </span>
          <span class="label">Strobe N-Filter on Overheat:</span>
        </label>
      </div>
      <div class="setting">
        <label class="toggle-switchy" data-text="yesno" data-label="left">
          <input id="overheatSyncToFan" name="overheatSyncToFan" type="checkbox" />
          <span class="toggle">
            <span class="switch"></span>
          </span>
          <span class="label">Overheat Sync Smoke to Fan:</span>
        </label>
      </div>
      <div class="setting">
        <label class="toggle-switchy" data-text="yesno" data-label="left">
          <input id="ribbonCableAlarm" name="ribbonCableAlarm" type="checkbox" />
          <span class="toggle">
            <span class="switch"></span>
          </span>
          <span class="label">Respond to Ribbon Cable Alarm:</span>
        </label>
      </div>
      <div class="setting">
        <label class="toggle-switchy" data-text="yesno" data-label="left">
          <input id="wandQuickBootup" name="wandQuickBootup" type="checkbox" />
          <span class="toggle">
            <span class="switch"></span>
          </span>
          <span class="label">Short Bootup from Wand:</span>
        </label>
      </div>
      <div class="setting">
        <label class="toggle-switchy" data-text="yesno" data-label="left">
          <input id="demoLightMode" name="demoLightMode" type="checkbox" />
          <span class="toggle">
            <span class="switch"></span>
          </span>
          <span class="label">Start Pack at Battery On:</span>
        </label>
      </div>
    </div>

    <h1>Audio Options</h1>
    <div class="block left">
      <div class="setting">
        <b>Master Volume % at Startup:</b>
        <br />
        <input type="range" id="defaultPackVolume" name="defaultPackVolume" min="5" max="100" value="100" step="5" oninput="masterVolOut.value=defaultPackVolume.value" />
        <output class="labelSlider" id="masterVolOut" for="defaultPackVolume"></output>
      </div>
      <div class="setting">
        <label class="toggle-switchy" data-label="left">
          <input id="protonStreamEffects" name="protonStreamEffects" type="checkbox" />
          <span class="toggle">
            <span class="switch"></span>
          </span>
          <span class="label">Proton Stream Impact Effects:</span>
        </label>
      </div>
      <div class="setting" id="gpstarAudioLedToggle">
        <label class="toggle-switchy" data-label="left">
          <input id="gpstarAudioLed" name="gpstarAudioLed" type="checkbox" />
          <span class="toggle">
            <span class="switch"></span>
          </span>
          <span class="label">GPStar Audio Status LED:</span>
        </label>
      </div>
    </div>

    <h1>Cyclotron Lid</h1>
    <div class="block left">
      <div class="setting">
        <b>LED Count:</b>
        <select id="ledCycLidCount" name="ledCycLidCount" style="width: 200px">
          <option value="12">12 - Stock</option>
          <option value="20">20 - Frutto (4x5)</option>
          <option value="36">36 - GPStar (4x9)</option>
          <option value="40">40 - RGB Ring</option>
        </select>
      </div>
      <div class="setting">
        <b>Custom Colour (Hue):</b>
        <br />
        <input
          type="range"
          id="ledCycLidHue"
          name="ledCycLidHue"
          min="2"
          max="360"
          value="360"
          step="2"
          oninput="updateColour('cycColourPreview', 'cycHueOut', 'cycSatOut', ledCycLidHue.value, ledCycLidSat.value)"
        />
        <output class="labelSlider" id="cycHueOut" for="ledCycLidHue"></output>
        <br />
        <div id="cycColourPreview" class="swatch"></div>
      </div>
      <div class="setting">
        <b>Custom Saturation %:</b>
        <br />
        <input
          type="range"
          id="ledCycLidSat"
          name="ledCycLidSat"
          min="2"
          max="100"
          value="100"
          step="2"
          oninput="updateColour('cycColourPreview', 'cycHueOut', 'cycSatOut', ledCycLidHue.value, ledCycLidSat.value)"
        />
        <output class="labelSlider" id="cycSatOut" for="ledCycLidSat"></output>
      </div>
      <div class="setting">
        <b>Brightness %:</b>
        <br />
        <input type="range" id="ledCycLidLum" name="ledCycLidLum" min="20" max="100" value="100" step="5" oninput="cycLumOut.value=ledCycLidLum.value" />
        <output class="labelSlider" id="cycLumOut" for="ledCycLidLum"></output>
      </div>
      <div class="setting">
        <label class="toggle-switchy" data-text="direction" data-label="left">
          <input id="cyclotronDirection" name="cyclotronDirection" type="checkbox" />
          <span class="toggle">
            <span class="switch"></span>
          </span>
          <span class="label">Spin Direction:</span>
        </label>
      </div>
      <div class="setting">
        <b>&nbsp;&nbsp;&nbsp;Center LEDs:</b>
        <select id="ledCycLidCenter" name="ledCycLidCenter">
          <option value="0">3 LED</option>
          <option value="1">1 LED</option>
        </select>
      </div>
      <div class="setting">
        <label class="toggle-switchy" data-label="left">
          <input id="ledCycLidFade" name="ledCycLidFade" type="checkbox" />
          <span class="toggle">
            <span class="switch"></span>
          </span>
          <span class="label">Center LED Fade Effect:</span>
        </label>
      </div>
      <div class="setting">
        <label class="toggle-switchy" data-label="left">
          <input id="ledCycLidSimRing" name="ledCycLidSimRing" type="checkbox" />
          <span class="toggle">
            <span class="switch"></span>
          </span>
          <span class="label">Simulated Ring Spin Effect:</span>
        </label>
      </div>
      <div class="setting">
        <label class="toggle-switchy" data-label="left">
          <input id="ledVGCyclotron" name="ledVGCyclotron" type="checkbox" />
          <span class="toggle">
            <span class="switch"></span>
          </span>
          <span class="label">Video Game Colours:</span>
        </label>
      </div>
    </div>

    <h1>Inner Cyclotron</h1>
    <div class="block left">
      <div class="setting">
        <b>Inner Panel (RGB LEDs):</b>
        <select id="ledCycInnerPanel" name="ledCycInnerPanel" style="width: 180px">
          <option value="1">Disabled</option>
          <option value="2">Static Colours</option>
          <option value="3">Dynamic Colours</option>
        </select>
      </div>
      <div class="setting">
        <b>Panel Brightness %:</b>
        <br />
        <input type="range" id="ledCycPanLum" name="ledCycPanLum" min="20" max="100" value="100" step="5" oninput="panLumOut.value=ledCycPanLum.value" />
        <output class="labelSlider" id="panLumOut" for="ledCycPanLum"></output>
      </div>
      <div class="setting">
        <b>Ring LED Count:</b>
        <select id="ledCycCakeCount" name="ledCycCakeCount">
          <option value="36">36 - GPStar</option>
          <option value="35">35</option>
          <option value="26">26</option>
          <option value="24">24</option>
          <option value="23">23</option>
          <option value="12">12</option>
        </select>
      </div>
      <div class="setting">
        <label class="toggle-switchy" data-text="yesno" data-label="left">
          <input id="ledCycCakeGRB" name="ledCycCakeGRB" type="checkbox" />
          <span class="toggle">
            <span class="switch"></span>
          </span>
          <span class="label">Swap Red/Green LEDs (GRB):</span>
        </label>
      </div>
      <div class="setting">
        <b>Custom Colour (Hue):</b>
        <br />
        <input
          type="range"
          id="ledCycCakeHue"
          name="ledCycCakeHue"
          min="2"
          max="360"
          value="360"
          step="2"
          oninput="updateColour('cakeColourPreview', 'cakeHueOut', 'cakeSatOut', ledCycCakeHue.value, ledCycCakeSat.value)"
        />
        <output class="labelSlider" id="cakeHueOut" for="ledCycCakeHue"></output>
        <br />
        <div id="cakeColourPreview" class="swatch"></div>
      </div>
      <div class="setting">
        <b>Custom Saturation %:</b>
        <br />
        <input
          type="range"
          id="ledCycCakeSat"
          name="ledCycCakeSat"
          min="2"
          max="100"
          value="100"
          step="2"
          oninput="updateColour('cakeColourPreview', 'cakeHueOut', 'cakeSatOut', ledCycCakeHue.value, ledCycCakeSat.value)"
        />
        <output class="labelSlider" id="cakeSatOut" for="ledCycCakeSat"></output>
      </div>
      <div class="setting">
        <b>Brightness %:</b>
        <br />
        <input type="range" id="ledCycCakeLum" name="ledCycCakeLum" min="20" max="100" value="100" step="5" oninput="cakeLumOut.value=ledCycCakeLum.value" />
        <output class="labelSlider" id="cakeLumOut" for="ledCycCakeLum"></output>
      </div>
      <div class="setting">
        <b>Cyclotron Cavity Lights:</b>
        <br />
        <input type="range" id="ledCycCavCount" name="ledCycCavCount" min="0" max="20" value="0" step="2" oninput="ledCycCavCountOut.value=ledCycCavCount.value" />
        <output class="labelSlider" id="ledCycCavCountOut" for="ledCycCavCount"></output>
      </div>
      <div class="setting">
        <b>Cavity LED Type:</b>
        <select id="ledCycCavType" name="ledCycCavType">
          <option value="1">RGB</option>
          <option value="2">GRB</option>
          <option value="3">GBR</option>
        </select>
      </div>
    </div>

    <h1>Power Cell</h1>
    <div class="block left">
      <div class="setting">
        <b>LED Count:</b>
        <select id="ledPowercellCount" name="ledPowercellCount">
          <option value="13">13 - Stock</option>
          <option value="15">15 - GPStar</option>
        </select>
      </div>
      <div class="setting">
        <b>Custom Colour (Hue):</b>
        <br />
        <input
          type="range"
          id="ledPowercellHue"
          name="ledPowercellHue"
          min="2"
          max="360"
          value="360"
          step="2"
          oninput="updateColour('pcColourPreview', 'pcHueOut', 'pcSatOut', ledPowercellHue.value, ledPowercellSat.value)"
        />
        <output class="labelSlider" id="pcHueOut" for="ledPowercellHue"></output>
        <br />
        <div id="pcColourPreview" class="swatch"></div>
      </div>
      <div class="setting">
        <b>Custom Saturation %:</b>
        <br />
        <input
          type="range"
          id="ledPowercellSat"
          name="ledPowercellSat"
          min="2"
          max="100"
          value="100"
          step="2"
          oninput="updateColour('pcColourPreview', 'pcHueOut', 'pcSatOut', ledPowercellHue.value, ledPowercellSat.value)"
        />
        <output class="labelSlider" id="pcSatOut" for="ledPowercellSat"></output>
      </div>
      <div class="setting">
        <b>Brightness %:</b>
        <br />
        <input type="range" id="ledPowercellLum" name="ledPowercellLum" min="20" max="100" value="100" step="5" oninput="pcLumOut.value=ledPowercellLum.value" />
        <output class="labelSlider" id="pcLumOut" for="ledPowercellLum"></output>
      </div>
      <div class="setting">
        <label class="toggle-switchy" data-text="yesno" data-label="left">
          <input id="ledInvertPowercell" name="ledInvertPowercell" type="checkbox" />
          <span class="toggle">
            <span class="switch"></span>
          </span>
          <span class="label">Invert Power Cell Animation:</span>
        </label>
      </div>
      <div class="setting">
        <label class="toggle-switchy" data-label="left">
          <input id="ledVGPowercell" name="ledVGPowercell" type="checkbox" />
          <span class="toggle">
            <span class="switch"></span>
          </span>
          <span class="label">Video Game Colours:</span>
        </label>
      </div>
    </div>

    <div id="gpstar2">
      <h1>GPStar II Options</h1>
      <div class="block left">
        <p>
          WiFi is automatically enabled on the GPStar II Proton Pack except when an Attenuator is attached. It is advised to keep WiFi disabled to save power, unless needed to
          perform firmware updates.
        </p>
        <div class="setting">
          <label class="toggle-switchy" data-text="yesno" data-label="left">
            <input id="wifiState" name="wifiState" type="checkbox" />
            <span class="toggle">
              <span class="switch"></span>
            </span>
            <span class="label">Pack WiFi Enabled:</span>
          </label>
        </div>
        <div class="setting">
          <label class="toggle-switchy" data-text="yesno" data-label="left">
            <input id="resetWifiPassword" name="resetWifiPassword" type="checkbox" />
            <span class="toggle">
              <span class="switch"></span>
            </span>
            <span class="label">Reset WiFi Password:</span>
          </label>
        </div>
      </div>
    </div>

    <div class="block">
      <a href="#top">Top</a>
      <hr />
      <a href="/">&laquo; Back</a>
      &nbsp;&nbsp;
      <button type="button" class="green" style="width: 120px" onclick="saveSettings()" id="btnSave">Update&nbsp;Settings</button>
      <br />
      <br />
    </div>

    <script type="application/javascript" src="/common.js"></script>
    <script type="application/javascript">
      window.addEventListener("load", onLoad);

      function onLoad(event) {
        // Wait 0.4s for serial communications between devices.
        setTimeout(getSettings, 400);

        // Disable the save button until we obtain settings.
        disableEl("btnSave");
      }

      function disableControls() {
        // Disables all controls.
        disableEl("defaultSystemModePack");
        disableEl("defaultYearThemePack");
        disableEl("currentYearThemePack");
        disableEl("packVibration");
        disableEl("defaultPackVolume");
        disableEl("overheatLightsOff");
        disableEl("overheatStrobeNF");
        disableEl("overheatSyncToFan");
        disableEl("protonStreamEffects");
        disableEl("ribbonCableAlarm");
        disableEl("wandQuickBootup");
        disableEl("demoLightMode");
        disableEl("gpstarAudioLed");
        disableEl("ledCycLidCount");
        disableEl("ledCycLidHue");
        disableEl("ledCycLidSat");
        disableEl("ledCycLidLum");
        disableEl("cyclotronDirection");
        disableEl("ledCycLidCenter");
        disableEl("ledCycLidFade");
        disableEl("ledCycLidSimRing");
        disableEl("ledVGCyclotron");
        disableEl("ledCycInnerPanel");
        disableEl("ledCycPanLum");
        disableEl("ledCycCakeCount");
        disableEl("ledCycCakeGRB");
        disableEl("ledCycCakeHue");
        disableEl("ledCycCakeSat");
        disableEl("ledCycCakeLum");
        disableEl("ledCycCavCount");
        disableEl("ledCycCavType");
        disableEl("ledPowercellCount");
        disableEl("ledPowercellHue");
        disableEl("ledPowercellSat");
        disableEl("ledPowercellLum");
        disableEl("ledInvertPowercell");
        disableEl("ledVGPowercell");
        disableEl("gpstarAudioLedToggle");
        disableEl("wifiState");
        disableEl("resetWifiPassword");
        hideEl("gpstar2");
      }

      // Converts a value from one range to another: eg. convertRange(160, [2,254], [0,360])
      function convertRange(value, r1, r2) {
        return Math.round(((value - r1[0]) * (r2[1] - r2[0])) / (r1[1] - r1[0]) + r2[0]);
      }

      function updateColour(colourPreviewID, hueLabelID, satLabelID, hueValue, satValue) {
        // Updates the slider values and preview the selected colour using HSL.
        setHtml(hueLabelID, hueValue);
        setHtml(satLabelID, satValue);
        var lightness = convertRange(100 - parseInt(satValue, 10), [0, 100], [50, 100]);
        getEl(colourPreviewID).style.backgroundColor = "hsl(" + parseInt(hueValue, 10) + ", " + parseInt(satValue, 10) + "%, " + lightness + "%)";
      }

      function getSettings() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status >= 200 && this.status < 300) {
            var settings = JSON.parse(this.responseText);
            if (settings) {
              if (!settings.prefsAvailable) {
                disableControls();
                alert("An unexpected error occurred and preferences could not be downloaded. Please refresh the page to try again.");
                return;
              }

              if (settings.packPowered || settings.wandPowered) {
                disableControls();
                alert(
                  "Pack and/or Wand are currently running. Changes to settings will not be allowed. Turn off devices via toggle switches and reload the page to obtain the latest settings."
                );
                return;
              }

              if (settings.esp32Pack) {
                // Show any GPStar II options when hardware available.
                showEl("gpstar2");
                setToggle("wifiState", settings.wifiState);
                enableEl("wifiState");
                enableEl("resetWifiPassword");
              } else {
                // Hide all GPStar II options when not available.
                hideEl("gpstar2");
                disableEl("wifiState");
                disableEl("resetWifiPassword");
              }

              if (!settings.gpstarAudio) {
                // Hide the GPStar Audio LED Status toggle if pack is not using GPStar Audio.
                hideEl("gpstarAudioLedToggle");
                disableEl("gpstarAudioLed");
              }

              // Valid settings were received and both the pack and wand are off, so allow updating settings.
              enableEl("btnSave");

              /**
               * Note: Colour (hue) value range for FastLED uses the following scale, though CSS uses 0-360 for HSL colour.
               *  0 = Red
               *  32 = Orange
               *  64 = Yellow
               *  96 = Green
               *  128 = Aqua
               *  160 = Blue
               *  192 = Purple
               *  224 = Pink
               *  254 = Red
               */

              // Update fields with the current values, or supply an expected default as necessary.
              setValue("defaultSystemModePack", settings.defaultSystemModePack || 0);
              setValue("defaultYearThemePack", settings.defaultYearThemePack || 1); // Value cannot be 0.
              setValue("currentYearThemePack", settings.currentYearThemePack || 4); // Value cannot be 0.
              setValue("defaultPackVolume", settings.defaultPackVolume || 100); // Default to full volume.
              setHtml("masterVolOut", getValue("defaultPackVolume"));
              setValue("packVibration", settings.packVibration || 4);
              setToggle("protonStreamEffects", settings.protonStreamEffects);
              setToggle("ribbonCableAlarm", settings.ribbonCableAlarm);
              setToggle("wandQuickBootup", settings.wandQuickBootup);
              setToggle("overheatStrobeNF", settings.overheatStrobeNF);
              setToggle("overheatLightsOff", settings.overheatLightsOff);
              setToggle("overheatSyncToFan", settings.overheatSyncToFan);
              setToggle("demoLightMode", settings.demoLightMode);
              setToggle("gpstarAudioLed", settings.gpstarAudioLed);

              setValue("ledCycLidCount", settings.ledCycLidCount || 36); // GPStar: 36
              setValue("ledCycLidHue", convertRange(settings.ledCycLidHue || 254, [1, 254], [0, 360])); // Default: Red
              setValue("ledCycLidSat", convertRange(settings.ledCycLidSat || 254, [1, 254], [0, 100])); // Full Saturation
              setValue("ledCycLidLum", settings.ledCycLidLum || 100); // Full Brightness
              setHtml("cycLumOut", getValue("ledCycLidLum"));
              setToggle("cyclotronDirection", settings.cyclotronDirection);
              setValue("ledCycLidCenter", settings.ledCycLidCenter || 0);
              setToggle("ledCycLidFade", settings.ledCycLidFade);
              setToggle("ledVGCyclotron", settings.ledVGCyclotron);
              setToggle("ledCycLidSimRing", settings.ledCycLidSimRing);

              setValue("ledCycCakeCount", settings.ledCycCakeCount || 35); // Default: 35
              setValue("ledCycCakeHue", convertRange(settings.ledCycCakeHue || 254, [1, 254], [0, 360])); // Default: Red
              setValue("ledCycCakeSat", convertRange(settings.ledCycCakeSat || 254, [1, 254], [0, 100])); // Full Saturation
              setValue("ledCycCakeLum", settings.ledCycCakeLum || 100); // Full Brightness
              setHtml("cakeLumOut", getValue("ledCycCakeLum"));
              setValue("ledCycInnerPanel", settings.ledCycInnerPanel || 3); // Default: Dynamic
              setValue("ledCycPanLum", settings.ledCycPanLum || 100); // Full Brightness
              setHtml("panLumOut", getValue("ledCycPanLum"));
              setToggle("ledCycCakeGRB", settings.ledCycCakeGRB);
              setValue("ledCycCavCount", settings.ledCycCavCount || 0); // Default: 0
              setHtml("ledCycCavCountOut", getValue("ledCycCavCount"));
              setValue("ledCycCavType", settings.ledCycCavType || 1); // Default: RGB

              setValue("ledPowercellCount", settings.ledPowercellCount || 15); // GPStar: 15
              setToggle("ledInvertPowercell", settings.ledInvertPowercell);
              setValue("ledPowercellHue", convertRange(settings.ledPowercellHue || 160, [1, 254], [0, 360])); // Default: Blue
              setValue("ledPowercellSat", convertRange(settings.ledPowercellSat || 254, [1, 254], [0, 100])); // Full Saturation
              setValue("ledPowercellLum", settings.ledPowercellLum || 100); // Full Brightness
              setHtml("pcLumOut", getValue("ledPowercellLum"));
              setToggle("ledVGPowercell", settings.ledVGPowercell);

              // Update colour preview and value display for hue/saturation sliders.
              updateColour("cycColourPreview", "cycHueOut", "cycSatOut", getValue("ledCycLidHue"), getValue("ledCycLidSat"));
              updateColour("cakeColourPreview", "cakeHueOut", "cakeSatOut", getValue("ledCycCakeHue"), getValue("ledCycCakeSat"));
              updateColour("pcColourPreview", "pcHueOut", "pcSatOut", getValue("ledPowercellHue"), getValue("ledPowercellSat"));
            }
          } else if (this.readyState == 4) {
            // Handle error responses
            handleStatus(this.responseText);
          }
        };
        xhttp.open("GET", "/config/pack", true);
        xhttp.send();
      }

      function saveSettings() {
        // Saves current settings to pack, updating runtime variables and making changes immediately effective.
        // This does NOT save to the EEPROM automatically as the user is encouraged to test prior to that action.
        var settings = {
          defaultSystemModePack: getInt("defaultSystemModePack"),
          defaultYearThemePack: getInt("defaultYearThemePack") || 1,
          currentYearThemePack: getInt("currentYearThemePack") || 4,
          defaultPackVolume: getInt("defaultPackVolume") || 100,
          packVibration: getInt("packVibration") || 4,
          protonStreamEffects: getToggle("protonStreamEffects"),
          ribbonCableAlarm: getToggle("ribbonCableAlarm"),
          wandQuickBootup: getToggle("wandQuickBootup"),
          overheatStrobeNF: getToggle("overheatStrobeNF"),
          overheatLightsOff: getToggle("overheatLightsOff"),
          overheatSyncToFan: getToggle("overheatSyncToFan"),
          demoLightMode: getToggle("demoLightMode"),
          gpstarAudioLed: getToggle("gpstarAudioLed"),

          ledCycLidCount: getInt("ledCycLidCount") || 12,
          ledCycLidHue: convertRange(getInt("ledCycLidHue"), [0, 360], [1, 254]) || 254,
          ledCycLidSat: convertRange(getInt("ledCycLidSat"), [0, 100], [1, 254]) || 254,
          ledCycLidLum: getInt("ledCycLidLum") || 100,
          cyclotronDirection: getToggle("cyclotronDirection"),
          ledCycLidCenter: getInt("ledCycLidCenter"),
          ledCycLidFade: getToggle("ledCycLidFade"),
          ledVGCyclotron: getToggle("ledVGCyclotron"),
          ledCycLidSimRing: getToggle("ledCycLidSimRing"),

          ledCycCakeCount: getInt("ledCycCakeCount") || 35,
          ledCycCakeHue: convertRange(getInt("ledCycCakeHue"), [0, 360], [1, 254]) || 254,
          ledCycCakeSat: convertRange(getInt("ledCycCakeSat"), [0, 100], [1, 254]) || 254,
          ledCycCakeLum: getInt("ledCycCakeLum") || 100,
          ledCycInnerPanel: getInt("ledCycInnerPanel") || 3,
          ledCycPanLum: getInt("ledCycPanLum") || 100,
          ledCycCakeGRB: getToggle("ledCycCakeGRB"),
          ledCycCavCount: getInt("ledCycCavCount"),
          ledCycCavType: getInt("ledCycCavType") || 1,

          ledPowercellCount: getInt("ledPowercellCount") || 13,
          ledInvertPowercell: getToggle("ledInvertPowercell"),
          ledPowercellHue: convertRange(getInt("ledPowercellHue"), [0, 360], [1, 254]) || 160,
          ledPowercellSat: convertRange(getInt("ledPowercellSat"), [0, 100], [1, 254]) || 254,
          ledPowercellLum: getInt("ledPowercellLum") || 100,
          ledVGPowercell: getToggle("ledVGPowercell"),

          wifiState: getToggle("wifiState"),
          resetWifiPassword: getToggle("resetWifiPassword"),
        };
        var body = JSON.stringify(settings);

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4) {
            if (this.status == 200) {
              handleStatus(this.responseText);
              setTimeout(getSettings, 400); // Get latest settings.

              if (confirm("Settings successfully updated. Do you want to store the latest settings to the pack EEPROM?")) {
                saveEEPROM(); // Perform action only if the user answers OK to the confirmation.
              }
            } else {
              handleStatus(this.responseText);
            }
          }
        };
        xhttp.open("PUT", "/config/pack/save", true);
        xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.send(body);
      }

      function saveEEPROM() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4) {
            handleStatus(this.responseText);
          }
        };
        xhttp.open("PUT", "/eeprom/pack", true);
        xhttp.send();
      }
    </script>
  </body>
</html>
