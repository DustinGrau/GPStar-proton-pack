<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Cache-control" content="public" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Special Device Settings</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <h1 id="top">Special Device Settings</h1>
    <div class="block left">
      <p>
        Adjust settings unique to this device's web interface. Use this screen to customize the private network used by the built-in WiFi network.
        <br />
        You may also use
        <b>http://[PRIVATE_NETWORK].local</b>
        to access this device via your browser. Use the "Update Settings" button to save values to the controller.
      </p>
      <br />
    </div>
    <h1>General Options</h1>
    <div class="block left">
      <div class="setting">
        <b>Private Network:</b>
        <input
          type="text"
          id="wifiName"
          size="60"
          maxlength="32"
          placeholder="Custom SSID"
          title="Only letters, numbers, hyphens, and underscores are allowed, up to 32 characters."
        />
      </div>
      <div class="setting">
        <b>Controller Installation Orientation:</b>
        <br />
        <select id="orientation" class="custom-select" style="width: 320px">
          <option value="1">Components Up, USB Front</option>
          <option value="2">Components Up, USB Rear</option>
          <option value="3">Components Down, USB Front</option>
          <option value="4">Components Down, USB Rear</option>
          <option value="5">Components Left, USB Front</option>
          <option value="6">Components Left, USB Rear</option>
          <option value="7">Components Right, USB Front</option>
          <option value="8">Components Right, USB Rear</option>
          <option value="9">Factory Defaults (Debug)</option>
        </select>
      </div>
      <div class="setting">
        <b>Hard Iron Magnetic Offsets:</b>
        <br />
        <input type="text" id="hardIron1" size="9" maxlength="8" placeholder="X Axis" />
        <br />
        <input type="text" id="hardIron2" size="9" maxlength="8" placeholder="Y Axis" />
        <br />
        <input type="text" id="hardIron3" size="9" maxlength="8" placeholder="Z Axis" />
        <br />
      </div>
      <div class="setting">
        <b>Soft Iron Magnetic Mapping:</b>
        <br />
        <input type="text" id="softIron1" size="9" maxlength="8" placeholder="Value 1" />
        <input type="text" id="softIron2" size="9" maxlength="8" placeholder="Value 2" />
        <input type="text" id="softIron3" size="9" maxlength="8" placeholder="Value 3" />
        <br />
        <input type="text" id="softIron4" size="9" maxlength="8" placeholder="Value 4" />
        <input type="text" id="softIron5" size="9" maxlength="8" placeholder="Value 5" />
        <input type="text" id="softIron6" size="9" maxlength="8" placeholder="Value 6" />
        <br />
        <input type="text" id="softIron7" size="9" maxlength="8" placeholder="Value 7" />
        <input type="text" id="softIron8" size="9" maxlength="8" placeholder="Value 8" />
        <input type="text" id="softIron9" size="9" maxlength="8" placeholder="Value 9" />
      </div>
      <div class="setting">
        <b>Magnetic Field (&micro;T):</b>
        <br />
        <input type="text" id="magField" size="9" maxlength="8" placeholder="0" />
      </div>
      <div class="setting">
        <b>Song List:</b>
        <span id="byteCount"></span>
        <br />
        <textarea
          id="songList"
          name="songList"
          rows="40"
          cols="38"
          style="text-align: left"
          oninput="updateByteCount()"
          placeholder="Add a list of track names, 1 per line, up to 2000 Bytes in total"
        ></textarea>
      </div>
      <div class="setting">
        <b>Magnetometer Config:</b>
        <div id="magnetometerConfig"></div>
        <br />
        <b>Self-Test Results:</b>
        <div id="magnetometerSelfTest"></div>
        <br />
        <details>
          <summary><b>Raw Registers</b></summary>
          <table class="mag-reg-table">
            <tr>
              <th>Name</th>
              <th>Address</th>
              <th>Value</th>
            </tr>
            <tbody id="magRegTableBody"></tbody>
          </table>
        </details>
      </div>
    </div>

    <div class="block">
      <a href="#top">Top</a>
      <hr />
      <a href="/">&laquo; Back</a>
      &nbsp;&nbsp;
      <button type="button" class="green" style="width: 120px" onclick="saveSettings()">Update&nbsp;Settings</button>
      <br />
      <br />
    </div>

    <script type="application/javascript" src="/common.js"></script>
    <script type="application/javascript">
      window.addEventListener("load", onLoad);

      function onLoad(event) {
        // Wait 0.1s for page to fully load.
        setTimeout(getSettings, 100);
      }

      function updateByteCount() {
        var songList = getEl("songList");
        var byteCount = getEl("byteCount");
        var byteLength = new TextEncoder().encode(songList.value).length;
        byteCount.innerHTML = byteLength + "/2000 Bytes";
      }

      function getSettings() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status >= 200 && this.status < 300) {
            var settings = JSON.parse(this.responseText);
            if (settings) {
              // Update fields with the current values, or supply an expected default as necessary.
              setValue("wifiName", settings.wifiName || "");
              setValue("orientation", settings.orientation || 3);
              setValue("hardIron1", settings.hardIron1 ?? 0);
              setValue("hardIron2", settings.hardIron2 ?? 0);
              setValue("hardIron3", settings.hardIron3 ?? 0);
              setValue("softIron1", settings.softIron1 ?? 1);
              setValue("softIron2", settings.softIron2 ?? 0);
              setValue("softIron3", settings.softIron3 ?? 0);
              setValue("softIron4", settings.softIron4 ?? 0);
              setValue("softIron5", settings.softIron5 ?? 1);
              setValue("softIron6", settings.softIron6 ?? 0);
              setValue("softIron7", settings.softIron7 ?? 0);
              setValue("softIron8", settings.softIron8 ?? 0);
              setValue("softIron9", settings.softIron9 ?? 1);
              setValue("magField", settings.magField ?? 50);
              setValue("songList", settings.songList || "");
              updateByteCount();

              // Magnetometer Configuration
              if (settings.magConfig) {
                var infoHtml = "<table class='mag-info-table'>\n";
                infoHtml += "<tr><th>Performance Mode</th><td>" + settings.magConfig.performanceMode + "</td></tr>\n";
                infoHtml += "<tr><th>Data Rate</th><td>" + settings.magConfig.dataRate + "</td></tr>\n";
                infoHtml += "<tr><th>Range</th><td>" + settings.magConfig.range + "</td></tr>\n";
                infoHtml += "<tr><th>Operation Mode</th><td>" + settings.magConfig.operationMode + "</td></tr>\n";
                infoHtml += "</table>";
                getEl("magnetometerConfig").innerHTML = infoHtml;

                // Self-Test Results
                if (settings.magSelfTest) {
                  var testHtml = "<table class='mag-selftest-table'>\n";
                  testHtml += "<tr><th></th><th>X</th><th>Y</th><th>Z</th></tr>\n";
                  testHtml +=
                    "<tr><th>Baseline</th><td>" +
                    settings.magSelfTest.baseline[0] +
                    "</td><td>" +
                    settings.magSelfTest.baseline[1] +
                    "</td><td>" +
                    settings.magSelfTest.baseline[2] +
                    "</td></tr>\n";
                  testHtml +=
                    "<tr><th>Self-Test</th><td>" +
                    settings.magSelfTest.results[0] +
                    "</td><td>" +
                    settings.magSelfTest.results[1] +
                    "</td><td>" +
                    settings.magSelfTest.results[2] +
                    "</td></tr>\n";
                  testHtml +=
                    "<tr><th>Delta</th><td>" +
                    settings.magSelfTest.delta[0] +
                    "</td><td>" +
                    settings.magSelfTest.delta[1] +
                    "</td><td>" +
                    settings.magSelfTest.delta[2] +
                    "</td></tr>\n";
                  testHtml +=
                    "<tr><th>Pass</th><td>" +
                    (settings.magSelfTest.pass[0] ? "&check;" : "&#x274C") +
                    "</td><td>" +
                    (settings.magSelfTest.pass[1] ? "&check;" : "&#x274C") +
                    "</td><td>" +
                    (settings.magSelfTest.pass[2] ? "&check;" : "&#x274C") +
                    "</td></tr>\n";
                  testHtml += "</table>";
                  getEl("magnetometerSelfTest").innerHTML = testHtml;
                }

                // Optionally, show raw registers
                if (settings.magConfig.registers && settings.magConfig.registers.length > 0) {
                  var registerRows = "";
                  settings.magConfig.registers.forEach(function (reg) {
                    registerRows +=
                      "<tr><td>" + reg.name + "</td><td>0x" + reg.address.toString(16).padStart(2, "0") + "</td><td>0x" + reg.value.toString(16).padStart(2, "0") + "</td></tr>\n";
                  });
                  getEl("magRegTableBody").innerHTML = registerRows;
                }
              }
            }
          } else if (this.readyState == 4) {
            // Handle error responses
            handleStatus(this.responseText);
          }
        };
        xhttp.open("GET", "/config/device", true);
        xhttp.send();
      }

      function saveSettings() {
        // Do not allow saving if track list is too large for allowed storage space.
        if (getValue("songList").length > 2000) {
          alert("Error: Unable to save track listing (exceeds allowed bytes).");
          return;
        }

        // Do not allow saving if the new SSID is too short/long, or illegal.
        var wifiName = getText("wifiName");
        if (wifiName.length < 8) {
          alert("Error: Network name must be more than 8 characters.");
          return;
        }
        if (wifiName.length > 32) {
          // Field input size should disallow this, but check just in case.
          alert("Error: Network name cannot exceed 32 characters.");
          return;
        }
        var ssidRegex = /^[a-zA-Z0-9-_]*$/;
        if (!ssidRegex.test(wifiName)) {
          // The name for the SSID must conform to RFC standards which limits the allowed characters.
          alert("Error: Network name may only contain letters, numbers, hyphens, and underscores.");
          return;
        }

        // Saves current settings to attenuator, updating runtime variables and making changes immediately effective.
        var settings = {
          wifiName: wifiName,
          orientation: getInt("orientation") || 3,
          hardIron1: getFloat("hardIron1") || 0,
          hardIron2: getFloat("hardIron2") || 0,
          hardIron3: getFloat("hardIron3") || 0,
          softIron1: getFloat("softIron1") || 1,
          softIron2: getFloat("softIron2") || 0,
          softIron3: getFloat("softIron3") || 0,
          softIron4: getFloat("softIron4") || 0,
          softIron5: getFloat("softIron5") || 1,
          softIron6: getFloat("softIron6") || 0,
          softIron7: getFloat("softIron7") || 0,
          softIron8: getFloat("softIron8") || 0,
          softIron9: getFloat("softIron9") || 1,
          magField: getFloat("magField") || 50,
          songList: getText("songList"),
        };
        var body = JSON.stringify(settings);

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4) {
            if (this.status == 200) {
              handleStatus(this.responseText);
              getSettings(); // Refresh settings.
            }

            if (this.status == 201) {
              handleStatus(this.responseText);

              if (confirm("Restart device now?")) {
                doRestart();
              }
            }
          }
        };
        xhttp.open("PUT", "/config/device/save", true);
        xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.send(body);
      }

      function doRestart() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status >= 200 && this.status < 300) {
            // Reload the page after 2 seconds.
            setTimeout(function () {
              window.location.reload();
            }, 2000);
          }
        };
        xhttp.open("DELETE", "/restart", true);
        xhttp.send();
      }
    </script>
  </body>
</html>
